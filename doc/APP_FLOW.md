# 全能扫描系统 - 应用流程文档 (APP_FLOW)

## 1. 页面结构总览

系统由PC端Web管理页面和Android手持终端应用组成：

```
┌──────────────────────────────────────────┐
│  PC端：管理页面 (index.html)             │
│  路由：GET /                              │
│  用途：数据集管理、进度监控、二维码显示    │
├──────────────────────────────────────────┤
│  Android端：手持终端应用                  │
│  类型：原生Android应用 (APK)              │
│  用途：扫码连接、扫描箱号、显示分区、语音播报│
└──────────────────────────────────────────┘
```

---

## 2. PC端：管理页面

### 2.1 页面布局

```
┌──────────────────────────────────────────┐
│              全能扫描系统                  │
│           （页面标题，居中）                │
├──────────────────────────────────────────┤
│  ┌─────────────────────────────────────┐ │
│  │  连接信息                            │ │
│  │  服务器地址：http://192.168.1.100:5000│ │
│  │  [二维码图片]                        │ │
│  │  在线设备：3台                       │ │
│  └─────────────────────────────────────┘ │
├──────────────────────────────────────────┤
│  ┌─────────────────────────────────────┐ │
│  │  上传新数据集                        │ │
│  │  [选择文件(.xlsx)]                   │ │
│  │  [数据集名称输入框]                   │ │
│  │  [上传按钮]                          │ │
│  └─────────────────────────────────────┘ │
├──────────────────────────────────────────┤
│  数据集列表                              │
│  ┌─────────────────────────────────────┐ │
│  │ 名称 │ 文件名 │ 进度 │ 时间 │ 操作  │ │
│  ├──────┼────────┼──────┼──────┼──────┤ │
│  │ 批次A │ a.xlsx │ 5/100│ 1-01 │[设]│  │ │
│  │      │        │  (5%)│      │[导]│  │ │
│  │      │        │      │      │[删]│  │ │
│  ├──────┼────────┼──────┼──────┼──────┤ │
│  │ 批次B │ b.xlsx │ 0/50 │ 1-02 │[设]│  │ │
│  │      │        │  (0%)│      │[导]│  │ │
│  │      │        │      │      │[删]│  │ │
│  └─────────────────────────────────────┘ │
├──────────────────────────────────────────┤
│  实时扫描记录                            │
│  ┌─────────────────────────────────────┐ │
│  │ 箱号   │ 分区 │ 时间     │ 设备   │ │
│  ├────────┼──────┼──────────┼────────┤ │
│  │ ABC123 │ 1-2  │ 14:30:05 │ 设备1  │ │
│  │ DEF456 │ 3-1  │ 14:29:58 │ 设备2  │ │
│  │ GHI789 │ 2-4  │ 14:29:50 │ 设备1  │ │
│  └─────────────────────────────────────┘ │
└──────────────────────────────────────────┘
```

### 2.2 交互流程

#### 流程A：系统启动

```
用户操作                        系统响应
────────                        ────────
1. 双击 start.bat            → 启动Flask服务
                                 │
                                 ├─ 获取本机IP地址
                                 ├─ 生成连接二维码
                                 ├─ 在浏览器中打开管理页面
                                 └─ 显示服务器地址和二维码
```

#### 流程B：上传Excel数据集

```
用户操作                        系统响应
────────                        ────────
1. 点击"选择文件"            → 打开文件选择器（限.xlsx）
2. 选择一个.xlsx文件          → 显示文件名
3. 在名称输入框输入自定义名称  → 无
4. 点击"上传"按钮            → POST /api/upload
                                 │
                                 ├─ 成功 → 显示成功提示
                                 │        刷新数据集列表
                                 │        清空上传表单
                                 │
                                 └─ 失败 → 显示错误信息
                                          （如：文件格式错误、
                                            列数不足、
                                            文件为空等）
```

**上传验证规则：**
- 文件必须为.xlsx格式
- 文件不能为空（至少有表头+1行数据）
- 必须输入数据集名称（非空）
- 至少包含3列数据

#### 流程C：设置当前扫描数据集

```
用户操作                        系统响应
────────                        ────────
1. 点击某数据集的"设为当前"按钮 → POST /api/set-current-dataset
                                 │
                                 ├─ 成功 → 该数据集标记为当前
                                 │        所有手持终端自动获取更新
                                 │        刷新数据集列表（显示"当前"标识）
                                 │
                                 └─ 失败 → 显示错误信息
```

#### 流程D：导出数据

```
用户操作                        系统响应
────────                        ────────
1. 点击某数据集的"导出"按钮   → GET /api/export/{dataset_id}
                                 浏览器自动下载.xlsx文件
                                 文件名格式：{数据集名称}_导出.xlsx
```

#### 流程E：删除数据集

```
用户操作                        系统响应
────────                        ────────
1. 点击某数据集的"删除"按钮   → 弹出确认对话框：
                                 "确定要删除数据集 '{名称}' 吗？
                                  所有扫描记录将被清除。"
2a. 点击"确定"               → DELETE /api/datasets/{id}
                                 删除成功 → 刷新数据集列表
2b. 点击"取消"               → 关闭对话框，无操作
```

---

## 3. Android端：手持终端应用

### 3.1 应用结构

```
┌──────────────────────────────────────────┐
│  页面1：连接页面 (ConnectionActivity)     │
│  用途：扫码连接或手动输入服务器地址        │
├──────────────────────────────────────────┤
│  页面2：扫描页面 (ScanActivity)           │
│  用途：扫描箱号、显示分区、语音播报        │
└──────────────────────────────────────────┘
```

### 3.2 页面1：连接页面

#### 3.2.1 页面布局

```
┌──────────────────────────────┐
│      全能扫描系统              │
├──────────────────────────────┤
│                              │
│     [扫码连接] 按钮          │
│                              │
│   ──── 或 ────              │
│                              │
│  [服务器地址输入框]          │
│  http://192.168.1.100:5000  │
│                              │
│     [连接] 按钮              │
│                              │
│  连接状态：未连接            │
└──────────────────────────────┘
```

#### 3.2.2 连接流程

**流程F：扫码连接**

```
用户操作                        系统响应
────────                        ────────
1. 点击"扫码连接"按钮        → 打开二维码扫描界面
2. 扫描PC端显示的二维码      → 解析服务器地址
                                 │
                                 ├─ 解析成功 → 自动填充服务器地址
                                 │            自动尝试连接
                                 │
                                 └─ 解析失败 → 提示"二维码格式错误"
```

**流程G：手动连接**

```
用户操作                        系统响应
────────                        ────────
1. 手动输入服务器地址        → 无
2. 点击"连接"按钮            → GET /api/current-dataset
                                 │
                                 ├─ 连接成功 → 跳转到扫描页面
                                 │            显示当前数据集信息
                                 │            保存服务器地址到本地
                                 │
                                 ├─ 连接失败 → 显示错误信息
                                 │            （如：服务器无法访问）
                                 │
                                 └─ 无数据集 → 显示"请先在PC端创建数据集"
```

**流程H：断线重连**

```
触发条件                        系统响应
────────                        ────────
1. 网络中断                  → 检测到网络错误
                                 │
                                 ├─ 显示"连接已断开，正在重连..."
                                 ├─ 自动尝试重连（间隔5秒）
                                 ├─ 重连成功 → 恢复扫描功能
                                 └─ 重连失败 → 继续尝试（最多3次）
```

### 3.3 页面2：扫描页面

#### 3.3.1 页面布局（竖屏优化）

```
┌──────────────────────────────┐
│  ← 返回    批次A              │  ← 顶部栏（数据集名称+返回）
├──────────────────────────────┤
│  ████████░░░░  已扫 5/100(5%) │  ← 进度区
├──────────────────────────────┤
│  [扫描输入框（自动聚焦）]      │  ← 输入区
├──────────────────────────────┤
│                              │
│                              │
│          1-2                 │  ← 结果区（核心）
│     （超大字体，醒目颜色）      │     分区号 >=80px
│                              │
│    门店：XX路XX号XX店          │     门店地址（中等字）
│                              │
│        ● 已扫描               │     状态标签（仅重复时显示）
│                              │
├──────────────────────────────┤
│  最近扫描：                   │  ← 历史区
│  ABC123 → 1-2   14:30:05     │
│  DEF456 → 3-1   14:29:58     │
│  GHI789 → 2-4   14:29:50     │
│  JKL012 → 1-1   14:29:45     │
│  MNO345 → 5-2   14:29:30     │
└──────────────────────────────┘
```

#### 3.3.2 扫描交互流程

**流程I：正常扫描（首次）**

```
触发动作                        系统响应
────────                        ────────
1. 手持终端扫描头扫描条码     → 通过Broadcast接收扫描结果
2. 扫描结果传入应用           → POST /api/scan
                                 Body: {dataset_id, box_number}
                                 │
                                 ├─ 查询到箱号（首次扫描）
                                 │   ├─ 标记该箱号为已扫描（数据库更新）
                                 │   ├─ 结果区：显示分区号（大字，绿色）
                                 │   ├─ 结果区：显示门店地址
                                 │   ├─ 进度区：更新已扫描计数和百分比
                                 │   ├─ 历史区：新记录插入顶部
                                 │   ├─ 语音：播报"分区 X X"
                                 │   ├─ 本地：保存扫描记录到Room数据库
                                 │   └─ 输入框：清空并重新聚焦
                                 │
```

**流程J：重复扫描**

```
触发动作                        系统响应
────────                        ────────
1. 扫描一个已经扫过的箱号     → POST /api/scan
                                 │
                                 ├─ 查询到箱号（已扫描过）
                                 │   ├─ 不重复计数（scanned_count不变）
                                 │   ├─ 结果区：显示分区号（大字，黄色）
                                 │   ├─ 结果区：显示门店地址
                                 │   ├─ 结果区：显示"已扫描"状态标签
                                 │   ├─ 进度区：不变
                                 │   ├─ 历史区：新记录插入顶部
                                 │   ├─ 语音：仍然播报"分区 X X"
                                 │   ├─ 本地：保存扫描记录到Room数据库
                                 │   └─ 输入框：清空并重新聚焦
                                 │
```

**流程K：未找到**

```
触发动作                        系统响应
────────                        ────────
1. 扫描一个不存在的箱号       → POST /api/scan
                                 │
                                 ├─ 未查询到箱号
                                 │   ├─ 结果区：红色背景
                                 │   ├─ 结果区：显示"未找到该箱号"
                                 │   ├─ 进度区：不变
                                 │   ├─ 历史区：不添加记录
                                 │   ├─ 声音：播放警告音效
                                 │   ├─ 本地：不保存记录
                                 │   └─ 输入框：清空并重新聚焦
                                 │
```

**流程L：网络中断处理**

```
触发条件                        系统响应
────────                        ────────
1. 扫描时网络中断            → POST /api/scan 失败
                                 │
                                 ├─ 显示"网络错误，记录已保存"
                                 ├─ 本地：保存扫描记录到Room数据库
                                 │       标记为未上传
                                 ├─ 进度区：显示本地进度
                                 ├─ 后台：自动尝试上传未上传记录
                                 └─ 上传成功：更新本地记录状态
```

**流程M：返回连接页面**

```
用户操作                        系统响应
────────                        ────────
1. 点击"← 返回"按钮           → 跳转到连接页面
                                 扫描进度已实时保存，无需额外操作
```

---

## 4. 语音播报流程

### 4.1 数字转中文映射表

| 数字 | 中文 |
|------|------|
| 0 | 零 |
| 1 | 一 |
| 2 | 二 |
| 3 | 三 |
| 4 | 四 |
| 5 | 五 |
| 6 | 六 |
| 7 | 七 |
| 8 | 八 |
| 9 | 九 |

### 4.2 转换规则

```
输入分区号 → 去掉连字符"-" → 每个数字字符单独转换为中文 → 拼接
前缀固定为"分区"

示例：
  "1-2"  → "分区 一 二"
  "3-5"  → "分区 三 五"
  "12-1" → "分区 一 二 一"
  "10-3" → "分区 一 零 三"
```

### 4.3 播报时机
- 正常扫描：立即播报
- 重复扫描：立即播报（与正常扫描相同内容）
- 未找到：不播报语音，改为播放警告音效

### 4.4 Android TTS实现

```kotlin
import android.speech.tts.TextToSpeech
import java.util.Locale

class ScanActivity : AppCompatActivity() {
    private var tts: TextToSpeech? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        tts = TextToSpeech(this) { status ->
            if (status == TextToSpeech.SUCCESS) {
                val result = tts?.setLanguage(Locale.CHINA)
                if (result == TextToSpeech.LANG_MISSING_DATA || result == TextToSpeech.LANG_NOT_SUPPORTED) {
                    // 中文不支持，静默降级
                }
            }
        }
    }

    fun speakZone(zone: String) {
        val digitMap = mapOf(
            '0' to "零", '1' to "一", '2' to "二", '3' to "三", '4' to "四",
            '5' to "五", '6' to "六", '7' to "七", '8' to "八", '9' to "九"
        )

        val text = buildString {
            append("分区 ")
            for (char in zone) {
                digitMap[char]?.let { append(it).append(" ") }
            }
        }

        tts?.speak(text.trim(), TextToSpeech.QUEUE_FLUSH, null, null)
    }

    override fun onDestroy() {
        tts?.stop()
        tts?.shutdown()
        super.onDestroy()
    }
}
```

---

## 5. 数据流图

### 5.1 二维码连接数据流

```
PC端启动服务
        │
        ▼
生成服务器地址（http://IP:5000）
        │
        ▼
生成二维码（包含服务器地址）
        │
        ▼
手持终端扫描二维码
        │
        ▼
解析二维码内容
        │
        ▼
保存服务器地址到本地
        │
        ▼
GET /api/current-dataset
        │
        ├─ 成功 → 跳转扫描页面
        └─ 失败 → 显示错误
```

### 5.2 Excel上传数据流

```
用户选择.xlsx文件 + 输入名称
        │
        ▼
POST /api/upload（multipart/form-data）
        │
        ▼
服务端接收文件
        │
        ▼
openpyxl解析.xlsx
        │
        ├─ 验证格式（至少3列，至少1行数据）
        │
        ▼
写入数据库
        ├─ datasets表：插入一条记录（名称、文件名、总数）
        └─ boxes表：逐行插入箱号数据（箱号、门店、分区）
        │
        ▼
返回成功响应（JSON）
        │
        ▼
PC端刷新数据集列表
        │
        ▼
手持终端自动获取当前数据集更新
```

### 5.3 扫描查询数据流

```
手持终端扫描条码
        │
        ▼
通过Broadcast接收扫描结果
        │
        ▼
POST /api/scan（JSON: {dataset_id, box_number}）
        │
        ▼
服务端查询boxes表
WHERE dataset_id = ? AND box_number = ?
        │
        ├─ 找到 且 is_scanned = 0（首次）
        │   ├─ UPDATE boxes SET is_scanned=1, scanned_at=NOW()
        │   ├─ UPDATE datasets SET scanned_count += 1
        │   ├─ 返回 {status:"found", zone, store_address, first_scan:true, progress}
        │   └─ PC端实时更新扫描记录列表
        │
        ├─ 找到 且 is_scanned = 1（重复）
        │   ├─ 返回 {status:"found", zone, store_address, first_scan:false, progress}
        │   └─ PC端实时更新扫描记录列表
        │
        └─ 未找到
            └─ 返回 {status:"not_found"}
```

### 5.4 导出数据流

```
点击"导出"按钮
        │
        ▼
GET /api/export/{dataset_id}
        │
        ▼
服务端查询boxes表所有记录
        │
        ▼
openpyxl创建新工作簿
        ├─ 表头：箱号、门店地址、分区、扫描状态、扫描时间
        └─ 逐行写入数据
        │
        ▼
返回.xlsx文件流（Content-Disposition: attachment）
        │
        ▼
浏览器自动下载文件
```

---

## 6. 状态转换

### 6.1 箱号状态

```
┌──────────┐     首次扫描      ┌──────────┐
│  未扫描   │ ──────────────→  │  已扫描   │
│is_scanned│                   │is_scanned│
│   = 0    │                   │   = 1    │
└──────────┘                   └──────────┘
                                    │
                               再次扫描
                                    │
                                    ▼
                              状态不变，
                              返回重复扫描提示
```

### 6.2 数据集生命周期

```
上传Excel ──→ 创建数据集 ──→ 设置为当前 ──→ 扫描中 ──→ 扫描完成(100%)
                  │                                       │
                  └──── 用户点击删除 ──→ 确认 ──→ 彻底删除 ◄─┘
                                         │
                                    取消 → 保持不变
```

### 6.3 手持终端连接状态

```
┌──────────┐     扫码/手动输入     ┌──────────┐
│  未连接   │ ─────────────────→  │  连接中   │
└──────────┘                      └──────────┘
                                         │
                                    连接成功
                                         │
                                         ▼
                                  ┌──────────┐
                                  │  已连接   │
                                  └──────────┘
                                         │
                                    网络中断
                                         │
                                         ▼
                                  ┌──────────┐
                                  │  断线重连 │
                                  └──────────┘
                                         │
                              ┌──────────┴──────────┐
                              ▼                       ▼
                         重连成功                  重连失败
                              │                       │
                              ▼                       ▼
                         ┌──────────┐          ┌──────────┐
                         │  已连接   │          │  未连接   │
                         └──────────┘          └──────────┘
```

---

## 7. 错误处理

| 场景 | 处理方式 |
|------|---------|
| 上传非.xlsx文件 | 前端限制文件选择器accept=".xlsx"，后端校验扩展名，返回错误提示 |
| Excel无数据行 | 后端校验，返回"文件中没有数据"错误 |
| Excel列数不足 | 后端校验，返回"文件格式不正确，需要至少3列数据"错误 |
| 数据集名称为空 | 前端校验，禁止提交 |
| 扫描时网络断开 | 手持终端显示网络错误，本地保存扫描记录，后台自动重连上传 |
| 删除不存在的数据集 | 后端返回404，前端刷新列表 |
| 导出空数据集 | 正常导出，所有箱号状态为"未扫描" |
| 二维码格式错误 | 手持终端提示"二维码格式错误"，允许手动输入 |
| 服务器无法访问 | 手持终端提示"无法连接到服务器"，允许重新输入地址 |
| TTS不支持中文 | 静默降级，不影响扫描功能 |
| 扫描头Broadcast不统一 | 提供多种扫描头集成方案，支持常见设备 |

---

## 8. 实时通信

### 8.1 PC端到手持终端的实时更新

**场景：**
- 数据集被设置为当前
- 数据集被删除
- 扫描进度更新

**实现方式：**
- 手持终端定期轮询（每5秒）GET /api/current-dataset
- 获取当前数据集信息
- 如果数据集ID变化，自动刷新页面

### 8.2 手持终端到PC端的实时更新

**场景：**
- 扫描箱号
- 连接/断开

**实现方式：**
- 扫描时通过POST /api/scan上传
- PC端实时更新扫描记录列表
- 使用WebSocket（可选）实现更实时的推送
